---
import { getCollection } from "astro:content";
import "@/styles/booking-modal.css";

/** === –î–ê–ù–ù–´–ï –ò–ó –ö–û–õ–õ–ï–ö–¶–ò–ô === */
const massages = await getCollection("massages");
const masters = await getCollection("masters");

/** –ü–æ—Ä—è–¥–æ–∫ –∏ –ø–æ–¥–ø–∏—Å–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
const categoryOrder = new Map([
  ["spa", 1],
  ["zones", 2],
]);
const categoryLabels: Record<string, string> = {
  spa: "–ü—Ä–æ–≥—Ä–∞–º–º—ã SPA",
  zones: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ",
};

/** –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º */
type Option = { value: string; label: string; order: number };
type Group = { key: string; title: string; order: number; options: Option[] };

const groupMap = new Map<string, Group>();
for (const entry of massages) {
  const d = entry.data as any;
  const key = d.category ?? "spa";
  if (!groupMap.has(key)) {
    groupMap.set(key, {
      key,
      title: d.categoryTitle ?? categoryLabels[key] ?? key,
      order: categoryOrder.get(key) ?? Number.MAX_SAFE_INTEGER,
      options: [],
    });
  }
  const g = groupMap.get(key)!;
  g.options.push({
    value: d.title,
    label: d.duration ? `${d.title} ¬∑ ${d.duration}` : d.title,
    order: typeof d.order === "number" ? d.order : Number.MAX_SAFE_INTEGER,
  });
}
const programGroups = [...groupMap.values()]
  .map((g) => ({ ...g, options: g.options.sort((a, b) => a.order - b.order) }))
  .sort((a, b) => a.order - b.order);

const defaultProgram = programGroups[0]?.options[0]?.value ?? "";
const defaultMaster = masters[0]?.data.name ?? "";

/** –¢–µ–∫—Å—Ç –≤ —à–∞–ø–∫–µ –º–æ–¥–∞–ª–∫–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ props */
const {
  modalTitle = "–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å",
  modalSubtitle = "–£–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –¥–ª—è —Å–µ–∞–Ω—Å–∞ - –º—ã —Å –í–∞–º–∏ —Å–≤—è–∂–µ–º—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
} = Astro.props;
---

<section
  id="booking"
  class="booking-modal"
  data-booking-modal
  aria-hidden="true"
  role="presentation"
>
  <div class="booking-modal__backdrop" data-backdrop></div>

  <div
    class="booking-modal__panel"
    role="dialog"
    aria-modal="true"
    aria-labelledby="booking-modal-title"
  >
    <button class="booking-modal__close" type="button" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>

    <header class="booking-modal__header">
      <p class="booking-modal__eyebrow">Relax For You</p>
      <h2 id="booking-modal-title" class="booking-modal__title">{modalTitle}</h2>
      <p class="booking-modal__subtitle">{modalSubtitle}</p>
    </header>

    <form class="booking-modal__form" data-form novalidate>
      <!-- üêù honeypot (–±–æ—Ç—ã –∑–∞–ø–æ–ª–Ω—è—é—Ç ‚Äî –º—ã –∏–≥–Ω–æ—Ä–∏–º) -->
      <input
        type="text"
        name="company"
        aria-hidden="true"
        tabindex="-1"
        autocomplete="off"
        style="position:absolute;left:-9999px;opacity:0;"
      />

      <!-- –ò–º—è -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="booking-name">–ò–º—è*</label>
        <input
          id="booking-name"
          name="name"
          class="booking-modal__input"
          type="text"
          placeholder="–ö–∞–∫ –∫ –í–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?"
          required
          autocomplete="name"
        />
      </div>

      <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="booking-phone">–¢–µ–ª–µ—Ñ–æ–Ω*</label>
        <input
          id="booking-phone"
          name="phone"
          class="booking-modal__input"
          type="tel"
          placeholder="+7..."
          required
          autocomplete="tel"
          inputmode="tel"
        />
      </div>

      <!-- –ü—Ä–æ–≥—Ä–∞–º–º–∞ -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="booking-program">–ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–∞—Å—Å–∞–∂–∞*</label>
        <select id="booking-program" name="selected_program" class="booking-modal__select" required>
          {
            programGroups.map((group) => (
              <optgroup label={group.title}>
                {group.options.map((o) => (
                  <option value={o.value} selected={o.value === defaultProgram}>
                    {o.label}
                  </option>
                ))}
              </optgroup>
            ))
          }
        </select>
      </div>

      <div class="booking-modal__row">
        <!-- –î–∞—Ç–∞ -->
        <div class="booking-modal__field">
          <label class="booking-modal__label" for="booking-date">–î–∞—Ç–∞*</label>
          <input
            id="booking-date"
            name="date"
            class="booking-modal__input"
            type="date"
            required
            min={new Date().toISOString().split("T")[0]}
            max={(() => {
              const d = new Date();
              d.setMonth(d.getMonth() + 3); // –º–∞–∫—Å–∏–º—É–º —á–µ—Ä–µ–∑ 3 –º–µ—Å—è—Ü–∞
              return d.toISOString().split("T")[0];
            })()}
          />
        </div>

        <!-- –í—Ä–µ–º—è -->
        <div class="booking-modal__field">
          <label class="booking-modal__label" for="booking-time">–í—Ä–µ–º—è*</label>
          <select id="booking-time" name="time" class="booking-modal__select" required>
            {
              Array.from({ length: 12 }, (_, i) => {
                const hour = 12 + i; // –æ—Ç 12 –¥–æ 23
                const formatted = String(hour).padStart(2, "0") + ":00";
                return <option value={formatted}>{formatted}</option>;
              })
            }
          </select>
        </div>
      </div>

      <!-- –ú–∞—Å—Ç–µ—Ä -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="booking-master">–ú–∞—Å—Ç–µ—Ä</label>
        <select id="booking-master" name="selected_master" class="booking-modal__select">
          {
            masters.map(({ data }: { data: any }) => (
              <option value={data.name} selected={data.name === defaultMaster}>
                {data.name}
              </option>
            ))
          }
        </select>
      </div>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="booking-message">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea
          id="booking-message"
          name="message"
          class="booking-modal__textarea"
          rows={4}
          placeholder="–£–∫–∞–∂–∏—Ç–µ –í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –¥–µ—Ç–∞–ª—è–º –∑–∞–ø–∏—Å–∏"></textarea>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div class="booking-modal__field">
        <button class="booking-modal__submit" type="submit" data-submit>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
      <p>–ò–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ù–ê–ú–ò –ø–æ –∑–≤–æ–Ω–∫—É –∏–ª–∏ —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
      <div class="booking-modal__actions">
        <a href="tel:+79533025946" class="booking-modal__alt-btn">üìû –°–≤—è–∑–∞—Ç—å—Å—è –ø–æ –∑–≤–æ–Ω–∫—É</a>
        <a href="https://t.me/IrinaMassage79" class="booking-modal__alt-btn"
          >üí¨ –°–≤—è–∑–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è</a
        >
      </div>

      <p class="booking-modal__policy">
        –û—Ç–ø—Ä–∞–≤–ª—è—è —Ñ–æ—Ä–º—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π
        –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ Relax For You.
      </p>

      <div class="booking-modal__feedback" data-feedback role="status" aria-live="polite" hidden>
      </div>
    </form>
    <div class="booking-modal__overlay-message" data-overlay-message hidden></div>
  </div>
</section>

<!-- ================== JS ================== -->
<script is:inline>
  (() => {
    const WEBHOOK_URL = "https://eop0updorcbwyjv.m.pipedream.net"; // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π

    const modal = document.querySelector("[data-booking-modal]");
    if (!modal) return;

    const form = modal.querySelector("[data-form]");
    const feedback = modal.querySelector("[data-feedback]");
    const submitBtn = modal.querySelector("[data-submit]");
    const closeBtns = modal.querySelectorAll("[data-close]");
    const backdrop = modal.querySelector("[data-backdrop]");
    const triggers = document.querySelectorAll('a[href="#booking"], [data-booking-trigger]');
    const firstField = modal.querySelector("#booking-name");
    const programSelect = modal.querySelector("#booking-program");
    const masterSelect = modal.querySelector("#booking-master");
    const phoneInput = modal.querySelector("#booking-phone");
    const defaultSubmitText = submitBtn?.textContent || "";

    // localStorage: –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω
    try {
      const savedName = localStorage.getItem("rfy_name");
      const savedPhone = localStorage.getItem("rfy_phone");
      if (savedName) modal.querySelector("#booking-name").value = savedName;
      if (savedPhone) phoneInput.value = savedPhone;

      modal
        .querySelector("#booking-name")
        ?.addEventListener("input", (e) => localStorage.setItem("rfy_name", e.target.value || ""));
      phoneInput?.addEventListener("input", (e) =>
        localStorage.setItem("rfy_phone", e.target.value || "")
      );
    } catch (_) {}

    const lockScroll = () => (document.body.style.overflow = "hidden");
    const unlockScroll = () => (document.body.style.overflow = "");

    const setFeedback = (msg, type) => {
      if (!feedback) return;

      feedback.textContent = msg || "";

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
      feedback.classList.remove("is-success", "is-error", "is-visible");

      if (msg) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –∏ –¥–µ–ª–∞–µ–º –≤–∏–¥–∏–º—ã–º
        if (type === "success") feedback.classList.add("is-success");
        if (type === "error") feedback.classList.add("is-error");
        feedback.classList.add("is-visible");
        feedback.hidden = false;
        feedback.style.display = "block";
      } else {
        // –°–∫—Ä—ã–≤–∞–µ–º
        feedback.classList.remove("is-visible", "is-success", "is-error");
        feedback.hidden = true;
        feedback.style.display = "none";
      }
    };

    const open = (dataset = {}) => {
      modal.setAttribute("data-open", "true");
      modal.setAttribute("aria-hidden", "false");
      lockScroll();

      // –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ dataset
      const { program, master } = dataset;
      if (program && programSelect) programSelect.value = program;
      if (master && masterSelect) masterSelect.value = master;

      // —Ñ–æ–∫—É—Å
      requestAnimationFrame(() => firstField?.focus());

      // —á–∏—Å—Ç–∏–º #hash
      if (location.hash === "#booking") {
        history.replaceState(null, "", location.pathname + location.search);
      }
    };

    const close = () => {
      modal.setAttribute("data-open", "false");
      modal.setAttribute("aria-hidden", "true");
      unlockScroll();
      setFeedback("", "");
      form instanceof HTMLFormElement && form.reset();
    };

    triggers.forEach((t) =>
      t.addEventListener("click", (e) => {
        e.preventDefault();
        open(t.dataset);
      })
    );
    closeBtns.forEach((b) => b.addEventListener("click", close));
    backdrop?.addEventListener("click", close);
    document.addEventListener(
      "keydown",
      (e) => e.key === "Escape" && modal.getAttribute("data-open") === "true" && close()
    );

    if (location.hash === "#booking") open();

    // –ù–µ–±–æ–ª—å—à–∞—è –º–∞—Å–∫–∞/–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function normalizePhone(raw) {
      const d = String(raw || "").replace(/\D/g, "");
      if (!d) return "";
      if (d.length === 10)
        return (
          "+7 (" + d.slice(0, 3) + ") " + d.slice(3, 6) + "-" + d.slice(6, 8) + "-" + d.slice(8, 10)
        );
      if (d.length >= 11)
        return (
          "+7 (" + d.slice(1, 4) + ") " + d.slice(4, 7) + "-" + d.slice(7, 9) + "-" + d.slice(9, 11)
        );
      return raw;
    }
    phoneInput?.addEventListener(
      "blur",
      () => (phoneInput.value = normalizePhone(phoneInput.value))
    );

    // === –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏: 12:00‚Äì23:59 ===
    const timeInput = modal.querySelector("#booking-time");
    const dateInput = modal.querySelector("#booking-date");

    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º "HH:MM" -> {h,m}
    function parseHM(v) {
      const [h, m] = String(v || "")
        .split(":")
        .map((n) => Number(n));
      return Number.isFinite(h) && Number.isFinite(m) ? { h, m } : null;
    }
    function toHM(h, m) {
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(h)}:${pad(m)}`;
    }
    const MIN_HM = { h: 12, m: 0 };
    const MAX_HM = { h: 23, m: 59 };

    function clampTimeStr(v) {
      const t = parseHM(v);
      if (!t) return toHM(MIN_HM.h, MIN_HM.m);
      const beforeMin = t.h < MIN_HM.h || (t.h === MIN_HM.h && t.m < MIN_HM.m);
      const afterMax = t.h > MAX_HM.h || (t.h === MAX_HM.h && t.m > MAX_HM.m);
      if (beforeMin) return toHM(MIN_HM.h, MIN_HM.m);
      if (afterMax) return toHM(MAX_HM.h, MAX_HM.m);
      return toHM(t.h, t.m);
    }

    function isTimeInRange(v) {
      const t = parseHM(v);
      if (!t) return false;
      const min = MIN_HM.h * 60 + MIN_HM.m;
      const cur = t.h * 60 + t.m;
      const max = MAX_HM.h * 60 + MAX_HM.m;
      return cur >= min && cur <= max;
    }

    // –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ/—É—Ö–æ–¥–µ —Ñ–æ–∫—É—Å–∞
    timeInput?.addEventListener("input", () => {
      timeInput.value = clampTimeStr(timeInput.value);
    });
    timeInput?.addEventListener("blur", () => {
      timeInput.value = clampTimeStr(timeInput.value);
    });

    // (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ ‚Äî –Ω–µ –¥–∞–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ –ø—Ä–æ—à–ª–æ–º
    function enforceNotPastIfToday() {
      if (!dateInput || !timeInput || !dateInput.value || !timeInput.value) return;
      const todayStr = new Date().toISOString().split("T")[0];
      if (dateInput.value !== todayStr) return;

      const now = new Date();
      const t = parseHM(timeInput.value);
      if (!t) return;

      const selected = new Date();
      selected.setHours(t.h, t.m, 0, 0);

      if (selected < now) {
        // –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è < 12:00 ‚Äî —Å—Ç–∞–≤–∏–º 12:00, –∏–Ω–∞—á–µ ‚Äî –±–ª–∏–∂–∞–π—à–∏–µ 5 –º–∏–Ω—É—Ç, –Ω–æ –Ω–µ –ø–æ–∑–∂–µ 23:59
        const floor5 = (n) => Math.ceil(n / 5) * 5; // –±–ª–∏–∂–∞–π—à–∏–µ –±—É–¥—É—â–∏–µ 5 –º–∏–Ω—É—Ç
        const nextH = now.getHours();
        const nextM = floor5(now.getMinutes());
        let nh = nextH,
          nm = nextM;
        if (nm >= 60) {
          nh += 1;
          nm = 0;
        }

        // –£—á–∏—Ç—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é/–≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—ã
        const bounded = clampTimeStr(toHM(nh, nm));
        timeInput.value = bounded;
      }
    }

    dateInput?.addEventListener("change", enforceNotPastIfToday);
    timeInput?.addEventListener("change", enforceNotPastIfToday);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Pipedream
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(form instanceof HTMLFormElement)) return;

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      // honeypot
      if (payload.company) return;

      const requiredFields = {
        name: "–ò–º—è",
        phone: "–¢–µ–ª–µ—Ñ–æ–Ω",
        selected_program: "–ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–∞—Å—Å–∞–∂–∞",
        date: "–î–∞—Ç–∞",
        time: "–í—Ä–µ–º—è",
      };

      // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
      form.querySelectorAll(".booking-modal__input, .booking-modal__select").forEach((el) => {
        el.classList.remove("is-error");
      });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
      const missing = Object.entries(requiredFields)
        .filter(([key]) => !payload[key] || String(payload[key]).trim() === "")
        .map(([_, label]) => label);

      if (missing.length > 0) {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∞–º–∏—Ö –ø–æ–ª–µ–π
        Object.keys(requiredFields).forEach((key) => {
          const el = form.querySelector(`[name="${key}"]`);
          if (!payload[key] || String(payload[key]).trim() === "") {
            el?.classList.add("is-error");
          }
        });

        setFeedback(`–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è: ${missing.join(", ")}.`, "error");
        return;
      }

      try {
        submitBtn.setAttribute("disabled", "true");
        submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶";
        setFeedback("", "");

        // –∞–Ω—Ç–∏–±–æ—Ç-–∑–∞–¥–µ—Ä–∂–∫–∞
        await new Promise((r) => setTimeout(r, 400 + Math.random() * 300));

        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: payload.name,
            phone: payload.phone,
            program: payload.selected_program,
            date: payload.date,
            time: payload.time,
            master: payload.selected_master || "",
            message: payload.message || "",
            channel: "–°–∞–π—Ç Relax For You",
            site: location.hostname,
          }),
        });

        if (res.ok) {
          setFeedback("‚úÖ –£—Å–ø–µ—à–Ω–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.", "success");
          form.reset();
          form.querySelectorAll(".booking-modal__input, .booking-modal__select").forEach((el) => {
            el.classList.remove("is-error");
          });
          setTimeout(() => setFeedback("", ""), 3000); // —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(close, 3200);
        } else {
          setFeedback("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "error");
        }
      } catch (err) {
        console.error(err);
        setFeedback("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.", "error");
      } finally {
        submitBtn.removeAttribute("disabled");
        submitBtn.textContent = defaultSubmitText;
      }
    });
  })();
</script>
