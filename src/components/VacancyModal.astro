---
import "@/styles/booking-modal.css";

/** –ó–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —á–µ—Ä–µ–∑ props */
const {
  modalTitle = "–û—Ç–∫–ª–∏–∫ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é",
  modalSubtitle = "–û—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ üíº",
} = Astro.props;
---

<section
  id="vacancy"
  class="booking-modal"
  data-vacancy-modal
  aria-hidden="true"
  role="presentation"
>
  <div class="booking-modal__backdrop" data-backdrop></div>

  <div
    class="booking-modal__panel"
    role="dialog"
    aria-modal="true"
    aria-labelledby="vacancy-modal-title"
  >
    <button class="booking-modal__close" type="button" data-close aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>

    <header class="booking-modal__header">
      <p class="booking-modal__eyebrow">Relax For You</p>
      <h2 id="vacancy-modal-title" class="booking-modal__title">{modalTitle}</h2>
      <p class="booking-modal__subtitle">{modalSubtitle}</p>
    </header>

    <form class="booking-modal__form" data-form novalidate>
      <!-- honeypot -->
      <input
        type="text"
        name="company"
        aria-hidden="true"
        tabindex="-1"
        autocomplete="off"
        style="position:absolute;left:-9999px;opacity:0;"
      />

      <!-- –ò–º—è -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="vacancy-name">–ò–º—è*</label>
        <input
          id="vacancy-name"
          name="name"
          class="booking-modal__input"
          type="text"
          placeholder="–í–∞—à–µ –∏–º—è"
          required
          autocomplete="name"
        />
      </div>

      <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="vacancy-phone">–¢–µ–ª–µ—Ñ–æ–Ω*</label>
        <input
          id="vacancy-phone"
          name="phone"
          class="booking-modal__input"
          type="tel"
          placeholder="+7..."
          required
          autocomplete="tel"
          inputmode="tel"
        />
      </div>

      <!-- –í–∞–∫–∞–Ω—Å–∏—è -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="vacancy-role">–ò–Ω—Ç–µ—Ä–µ—Å—É—é—â–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å*</label>
        <select id="vacancy-role" name="role" class="booking-modal__select" required>
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏—é</option>
          <option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–º–µ–Ω–µ–¥–∂–µ—Ä)">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–º–µ–Ω–µ–¥–∂–µ—Ä)</option>
          <option value="–ú–∞—Å—Ç–µ—Ä –º–∞—Å—Å–∞–∂–∞ –∏ SPA-–ø—Ä–æ—Ü–µ–¥—É—Ä">–ú–∞—Å—Ç–µ—Ä –º–∞—Å—Å–∞–∂–∞ –∏ SPA-–ø—Ä–æ—Ü–µ–¥—É—Ä</option>
          <option value="–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å">–£–ø—Ä–∞–≤–ª—è—é—â–∏–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</option>
        </select>
      </div>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div class="booking-modal__field">
        <label class="booking-modal__label" for="vacancy-message">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
        <textarea
          id="vacancy-message"
          name="message"
          class="booking-modal__textarea"
          rows={4}
          placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É..."></textarea>
      </div>

      <div class="booking-modal__field">
        <button class="booking-modal__submit" type="submit" data-submit>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–ª–∏–∫</button>
      </div>

      <p class="booking-modal__policy">
        –û—Ç–ø—Ä–∞–≤–ª—è—è –∑–∞—è–≤–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª–∏—Ç–∏–∫–æ–π
        –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ Relax For You.
      </p>

      <div class="booking-modal__feedback" data-feedback role="status" aria-live="polite" hidden>
      </div>
    </form>

    <div class="booking-modal__overlay-message" data-overlay-message hidden></div>
  </div>
</section>

<!-- ================== JS ================== -->
<script is:inline>
  (() => {
    const WEBHOOK_URL = "https://eoiolinmefd6i6s.m.pipedream.net"; // ‚Üê —Ç–æ—Ç –∂–µ –≤–µ–±—Ö—É–∫, —á—Ç–æ –∏ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤

    const modal = document.querySelector("[data-vacancy-modal]");
    if (!modal) return;

    const form = modal.querySelector("[data-form]");
    const feedback = modal.querySelector("[data-feedback]");
    const overlayMsg = modal.querySelector("[data-overlay-message]");
    const submitBtn = modal.querySelector("[data-submit]");
    const closeBtns = modal.querySelectorAll("[data-close]");
    const backdrop = modal.querySelector("[data-backdrop]");
    const triggers = document.querySelectorAll('a[href="#vacancy"], [data-vacancy-trigger]');
    const firstField = modal.querySelector("#vacancy-name");
    const phoneInput = modal.querySelector("#vacancy-phone");
    const defaultSubmitText = submitBtn?.textContent || "";

    const lockScroll = () => (document.body.style.overflow = "hidden");
    const unlockScroll = () => (document.body.style.overflow = "");

    const showOverlayMessage = (msg, type = "success", duration = 2500) => {
      if (!overlayMsg) return;
      overlayMsg.textContent = msg;
      overlayMsg.classList.remove("is-success", "is-error", "is-visible");
      if (type === "success") overlayMsg.classList.add("is-success");
      if (type === "error") overlayMsg.classList.add("is-error");
      overlayMsg.hidden = false;
      requestAnimationFrame(() => overlayMsg.classList.add("is-visible"));
      setTimeout(() => {
        overlayMsg.classList.remove("is-visible");
        overlayMsg.hidden = true;
      }, duration);
    };

    const open = () => {
      modal.setAttribute("data-open", "true");
      modal.setAttribute("aria-hidden", "false");
      lockScroll();
      requestAnimationFrame(() => firstField?.focus());
      if (location.hash === "#vacancy") {
        history.replaceState(null, "", location.pathname + location.search);
      }
    };

    const close = () => {
      modal.setAttribute("data-open", "false");
      modal.setAttribute("aria-hidden", "true");
      unlockScroll();
      form instanceof HTMLFormElement && form.reset();
    };

    triggers.forEach((t) =>
      t.addEventListener("click", (e) => {
        e.preventDefault();
        open();
      })
    );
    closeBtns.forEach((b) => b.addEventListener("click", close));
    backdrop?.addEventListener("click", close);
    document.addEventListener(
      "keydown",
      (e) => e.key === "Escape" && modal.getAttribute("data-open") === "true" && close()
    );
    if (location.hash === "#vacancy") open();

    // === –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
    function normalizePhone(raw) {
      const d = String(raw || "").replace(/\D/g, "");
      if (!d) return "";
      if (d.length === 10)
        return (
          "+7 (" + d.slice(0, 3) + ") " + d.slice(3, 6) + "-" + d.slice(6, 8) + "-" + d.slice(8, 10)
        );
      if (d.length >= 11)
        return (
          "+7 (" + d.slice(1, 4) + ") " + d.slice(4, 7) + "-" + d.slice(7, 9) + "-" + d.slice(9, 11)
        );
      return raw;
    }
    phoneInput?.addEventListener(
      "blur",
      () => (phoneInput.value = normalizePhone(phoneInput.value))
    );

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ ===
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!(form instanceof HTMLFormElement)) return;
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      if (payload.company) return; // honeypot

      const required = ["name", "phone", "role"];
      const missing = required.filter((f) => !payload[f] || String(payload[f]).trim() === "");
      if (missing.length > 0) {
        showOverlayMessage("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.", "error", 2600);
        return;
      }

      try {
        submitBtn.setAttribute("disabled", "true");
        submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶";
        await new Promise((r) => setTimeout(r, 400 + Math.random() * 300));

        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "vacancy",
            name: payload.name,
            phone: payload.phone,
            role: payload.role,
            message: payload.message,
            site: "https://relaxmassage51.ru",
          }),
        });

        if (res.ok) {
          showOverlayMessage("‚úÖ –°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.", "success", 2600);
          form.reset();
          setTimeout(close, 2800);
        } else {
          showOverlayMessage("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", "error", 2800);
        }
      } catch (err) {
        console.error(err);
        showOverlayMessage("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.", "error", 2800);
      } finally {
        submitBtn.removeAttribute("disabled");
        submitBtn.textContent = defaultSubmitText;
      }
    });
  })();
</script>
